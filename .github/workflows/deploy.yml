name: Deploy To EC2

on:
  push:
    branches:
      - main
      - develop
      - test

jobs:
  build:
    runs-on: ubuntu-latest
    environment: ${{ github.ref == 'refs/heads/main' && 'prod' || github.ref == 'refs/heads/develop' && 'dev' || github.ref == 'refs/heads/test' && 'prod' || github.ref == 'refs/heads/test/6-test-container-setting' && 'prod' }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          distribution: corretto
          java-version: '17'

      - name: Grant execute permission to gradlew
        run: chmod +x gradlew

      - name: Set PROFILE based on branch
        run: |
          if [[ "${GITHUB_REF_NAME}" == "main" ]] || [[ "${GITHUB_REF_NAME}" == "test" ]] || [[ "${GITHUB_REF_NAME}" == "test/6-test-container-setting" ]]; then
            echo "PROFILE=prod" >> $GITHUB_ENV
          else
            echo "PROFILE=dev" >> $GITHUB_ENV
          fi
        shell: bash

      - name: Make application-${{ env.PROFILE }}.properties
        shell: bash
        run: |
          mkdir -p ./src/main/resources
          cd ./src/main/resources

          if [[ "$PROFILE" == "dev" ]]; then
            echo "${{ secrets.APPLICATION_PROPERTIES_DEV }}" > application-dev.properties
            echo "âœ… wrote application-dev.properties"
          else
            echo "${{ secrets.APPLICATION_PROPERTIES_PROD }}" > application-prod.properties
            echo "âœ… wrote application-prod.properties"
          fi

      - name: Build WAR
        run: ./gradlew clean build --info

      - name: Login to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

  deploy:
    runs-on: ubuntu-latest
    needs: build
    environment: ${{ github.ref == 'refs/heads/main' && 'prod' || github.ref == 'refs/heads/develop' && 'dev' || github.ref == 'refs/heads/test' && 'prod' || github.ref == 'refs/heads/test/6-test-container-setting' && 'prod' }}
    steps:
      - name: Build Docker image
        run: |
          IMAGE_TAG=${{ secrets.DOCKERHUB_USERNAME }}/metalwallet-backend:${PROFILE}
          docker build -t $IMAGE_TAG .
  
      - name: Push Docker image
        run: |
          IMAGE_TAG=${{ secrets.DOCKERHUB_USERNAME }}/metalwallet-backend:${PROFILE}
          docker push $IMAGE_TAG

      - name: Copy docker-compose.yml to EC2
        uses: appleboy/scp-action@v0.1.2
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_KEY }}
          source: "docker-compose.yml"
          target: "/home/ubuntu/metal-wallet-backend-v2/"

      - name: Deploy to EC2 via SSH
        uses: appleboy/ssh-action@v0.1.7
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_KEY }}
          script: |
            SPRING_PROFILE=${{ env.PROFILE }}
            
            echo "ðŸ“¦ curr:"
            pwd
            ls -l
            echo "ðŸ“¦ dockerfile:"
            ls -l | grep -i dockerfile
            
            # ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì¤‘ì§€ ë° ì‚­ì œ
            docker stop myapp-$SPRING_PROFILE || true
            docker rm myapp-$SPRING_PROFILE || true
            
            # Docker Hubì—ì„œ ìµœì‹  ì´ë¯¸ì§€ pull
            docker pull ${{ secrets.DOCKERHUB_USERNAME }}/metalwallet-backend:$SPRING_PROFILE

            APP_DIR="/home/ubuntu/metal-wallet-backend-v2"
            
            echo "ðŸ“¦ Deploying ${SPRING_PROFILE} environment..."
            
            mkdir -p $APP_DIR
            cd $APP_DIR
            echo "ðŸ” Checking APP_DIR path..."
            pwd
            ls -l

            cat > .env <<EOF
            PROFILE=${SPRING_PROFILE}
            EOF
            
            echo "âœ… .env file created!"

            # ì»¨í…Œì´ë„ˆ ì‹¤í–‰ (docker-compose)
            docker compose --env-file .env up -d