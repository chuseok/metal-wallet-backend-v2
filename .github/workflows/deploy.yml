name: Deploy To EC2

on:
  push:
    branches:
      - main
      - develop
      - test
      - feature/8-loadtest

jobs:
  build:
    runs-on: ubuntu-latest
    environment: ${{ github.ref == 'refs/heads/main' && 'prod' || github.ref == 'refs/heads/develop' && 'dev' || github.ref == 'refs/heads/test' && 'prod' || github.ref == 'refs/heads/feature/8-loadtest' && 'prod' }}
    env:
      TEST_MYSQL_DB: ${{ secrets.TEST_MYSQL_DB }}
      TEST_MYSQL_USER: ${{ secrets.TEST_MYSQL_USER }}
      TEST_MYSQL_PASSWORD: ${{ secrets.TEST_MYSQL_PASSWORD }}
    outputs:
      PROFILE: ${{ steps.set-profile.outputs.profile }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          distribution: corretto
          java-version: '17'

      - name: Grant execute permission to gradlew
        run: chmod +x gradlew

      - name: Set PROFILE based on branch
        id: set-profile
        run: |
          if [[ "${GITHUB_REF_NAME}" == "main" ]] || [[ "${GITHUB_REF_NAME}" == "test" ]] || [[ "${GITHUB_REF_NAME}" == "feature/8-loadtest" ]]; then
            echo "PROFILE=prod" >> $GITHUB_ENV
            echo "profile=prod" >> $GITHUB_OUTPUT
          else
            echo "PROFILE=dev" >> $GITHUB_ENV
            echo "profile=dev" >> $GITHUB_OUTPUT
          fi
        shell: bash


      - name: Make application-test.properties
        shell: bash
        run: |
          mkdir -p ./src/main/resources
          cd ./src/main/resources
          echo "${{ secrets.APPLICATION_PROPERTIES_TEST }}" > application-test.properties
          echo "âœ… wrote application-test.properties"

      - name: Make application-${{ env.PROFILE }}.properties
        shell: bash
        run: |
          mkdir -p ./src/main/resources
          cd ./src/main/resources

          if [[ "$PROFILE" == "dev" ]]; then
            echo "${{ secrets.APPLICATION_PROPERTIES_DEV }}" > application-dev.properties
            echo "âœ… wrote application-dev.properties"
          else
            echo "${{ secrets.APPLICATION_PROPERTIES_PROD }}" > application-prod.properties
            echo "âœ… wrote application-prod.properties"
          fi

      - name: Build WAR
        run: ./gradlew clean build --stacktrace --info

      - name: Upload Test Results
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: build/test-results/

      - name: Upload war
        uses: actions/upload-artifact@v4
        with:
          name: war-file
          path: build/libs/*.war

  deploy:
    runs-on: ubuntu-latest
    needs: build
    env:
      PROFILE: ${{ needs.build.outputs.PROFILE }}
    environment: ${{ github.ref == 'refs/heads/main' && 'prod' || github.ref == 'refs/heads/develop' && 'dev' || github.ref == 'refs/heads/test' && 'prod' || github.ref == 'refs/heads/feature/8-loadtest' && 'prod' }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Download war from build job
        uses: actions/download-artifact@v4
        with:
          name: war-file
          path: ./artifact

      - name: Login to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build Docker image
        run: |
          WAR_FILE=$(ls artifact/*.war)
          IMAGE_TAG=${{ secrets.DOCKERHUB_USERNAME }}/metalwallet-backend:${{ env.PROFILE }}
          docker build --build-arg WAR_FILE=$WAR_FILE -t $IMAGE_TAG .
  
      - name: Push Docker image
        run: |
          IMAGE_TAG=${{ secrets.DOCKERHUB_USERNAME }}/metalwallet-backend:${{ env.PROFILE }}
          docker push $IMAGE_TAG

      - name: Copy docker-compose.yml to EC2
        uses: appleboy/scp-action@v0.1.2
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_KEY }}
          source: "docker-compose.yml"
          target: "/home/ubuntu/metal-wallet-backend-v2/"

      - name: Copy prometheus.yml to EC2
        uses: appleboy/scp-action@v0.1.2
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_KEY }}
          source: "prometheus.yml"
          target: "/home/ubuntu/metal-wallet-backend-v2/"

      - name: Create mysqld-exporter directory on EC2
        uses: appleboy/ssh-action@v0.1.7
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_KEY }}
          script: |
            mkdir -p /home/ubuntu/metal-wallet-backend-v2/mysqld-exporter

      - name: Copy .my.cnf to EC2
        uses: appleboy/scp-action@v0.1.2
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_KEY }}
          source: "mysqld-exporter/.my.cnf"
          target: "/home/ubuntu/metal-wallet-backend-v2/mysqld-exporter/.my.cnf"

      - name: Deploy to EC2 via SSH
        uses: appleboy/ssh-action@v0.1.7
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_KEY }}
          script: |
            SPRING_PROFILE=${{ env.PROFILE }}
            
            echo "ðŸ“¦ curr:"
            
            # ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì¤‘ì§€ ë° ì‚­ì œ
            docker stop myapp-$SPRING_PROFILE || true
            docker rm myapp-$SPRING_PROFILE || true
            
            # Docker Hubì—ì„œ ìµœì‹  ì´ë¯¸ì§€ pull
            docker pull ${{ secrets.DOCKERHUB_USERNAME }}/metalwallet-backend:$SPRING_PROFILE

            APP_DIR="/home/ubuntu/metal-wallet-backend-v2"
            
            echo "ðŸ“¦ Deploying ${SPRING_PROFILE} environment..."
            
            mkdir -p $APP_DIR
            cd $APP_DIR
            echo "ðŸ” Checking APP_DIR path..."
            pwd
            ls -l

            cat > .env <<EOF
            PROFILE=${SPRING_PROFILE}
            PROMETHEUS_USER=${{ secrets.PROMETHEUS_USER }}
            PROMETHEUS_PASSWORD=${{ secrets.PROMETHEUS_PASSWORD }}
            EOF
            
            echo "âœ… .env file created!"

            # ì»¨í…Œì´ë„ˆ ì‹¤í–‰ (docker-compose)
            docker compose --env-file .env up -d